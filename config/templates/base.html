{% load static wagtailcore_tags wagtailuserbar wagtailsettings_tags brand_tokens schema %}

<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    {% get_settings as site_settings %}

    <link rel="icon" href="{% static 'brand/brand_mark/Logo-01.svg' %}" type="image/svg+xml" />
    <link rel="icon" href="{% static 'brand/brand_mark/Logo-04.svg' %}" type="image/svg+xml" media="(prefers-color-scheme: dark)" />

    <title>
      {% block title %}
        {% if page.seo_title %}{{ page.seo_title }}{% elif page.title %}{{ page.title }}{% else %}SKINMENU{% endif %}
      {% endblock %}
    </title>

    {# --- Meta description fallback (NO meta_description_fallback var needed) --- #}
    {% firstof page.search_description page.summary page.excerpt page.intro "" as meta_desc %}

    {% block meta %}
      {% if meta_desc %}
        <meta name="description" content="{{ meta_desc|striptags|truncatechars:160 }}" />
      {% endif %}
    {% endblock %}

    {# --- Canonical + OG basics --- #}
    {% canonical_url as canon %}
    {% if canon %}
      <link rel="canonical" href="{{ canon }}" />
      <meta property="og:url" content="{{ canon }}" />
    {% endif %}

    <meta property="og:type" content="website" />
    <meta property="og:title" content="{% if page.seo_title %}{{ page.seo_title }}{% elif page.title %}{{ page.title }}{% else %}SKINMENU{% endif %}" />
    {% if meta_desc %}
      <meta property="og:description" content="{{ meta_desc|striptags|truncatechars:200 }}" />
    {% endif %}

    {% og_image_url as og_img %}
    {% if og_img %}
      <meta property="og:image" content="{{ og_img }}" />
    {% endif %}

    {# Optional twitter cards (safe defaults) #}
    <meta name="twitter:card" content="summary_large_image" />
    {% if og_img %}<meta name="twitter:image" content="{{ og_img }}" />{% endif %}
    <meta name="twitter:title" content="{% if page.seo_title %}{{ page.seo_title }}{% elif page.title %}{{ page.title }}{% else %}SKINMENU{% endif %}" />
    {% if meta_desc %}<meta name="twitter:description" content="{{ meta_desc|striptags|truncatechars:200 }}" />{% endif %}

    {# Prevent theme flash: set data-theme before CSS loads #}
    <script>
      (function () {
        try {
          var t = localStorage.getItem("skinmenu_theme");
          if (t === "light" || t === "dark") document.documentElement.dataset.theme = t;
        } catch (e) {}
      })();
    </script>

    <link rel="stylesheet" href="{% static 'css/app.css' %}" />

    {# Inline theme tokens from Wagtail settings (admin-editable) #}

{# Inline theme tokens from Wagtail settings (admin-editable) #}
{% with brand=site_settings.site_settings.BrandAppearanceSettings %}
  <style>
    :root {
      --bg: {{ brand.light_bg|hex_to_rgb }};
      --fg: {{ brand.light_fg|hex_to_rgb }};
      --surface: {{ brand.light_surface|hex_to_rgb }};
      --surface-2: {{ brand.light_surface_2|hex_to_rgb }};
      --border: {{ brand.light_border|hex_to_rgb }};
      --muted: {{ brand.light_muted|hex_to_rgb }};
      --heading: {{ brand.light_heading|hex_to_rgb }};
      --accent: {{ brand.light_accent|hex_to_rgb }};
      --accent-2: {{ brand.light_accent_2|hex_to_rgb }};

      /* Background texture controls (used by app.css) */
      --paper-texture-on: {% if brand.paper_texture_enabled %}1{% else %}0{% endif %};
      --paper-texture-strength: {{ brand.paper_texture_strength|default:100 }};

      /* Typography */
  --body-size: {{ brand.body_font_size_px|default:16 }}px;
  --body-wght: {{ brand.body_font_weight|default:400 }};
  --heading-wght: {{ brand.heading_font_weight|default:300 }};
  --ui-size: {{ brand.ui_font_size_px|default:15 }}px;
  --ui-wght: {{ brand.ui_font_weight|default:300 }};
    }
    :root[data-theme='dark'] {
      --bg: {{ brand.dark_bg|hex_to_rgb }};
      --fg: {{ brand.dark_fg|hex_to_rgb }};
      --surface: {{ brand.dark_surface|hex_to_rgb }};
      --surface-2: {{ brand.dark_surface_2|hex_to_rgb }};
      --border: {{ brand.dark_border|hex_to_rgb }};
      --muted: {{ brand.dark_muted|hex_to_rgb }};
      --heading: {{ brand.dark_heading|hex_to_rgb }};
      --accent: {{ brand.dark_accent|hex_to_rgb }};
      --accent-2: {{ brand.dark_accent_2|hex_to_rgb }};

      /* Typography */
  --body-size: {{ brand.body_font_size_px|default:16 }}px;
  --body-wght: {{ brand.body_font_weight|default:400 }};
  --heading-wght: {{ brand.heading_font_weight|default:300 }};
  --ui-size: {{ brand.ui_font_size_px|default:15 }}px;
  --ui-wght: {{ brand.ui_font_weight|default:300 }};

      /* Same controls in dark mode */
      --paper-texture-on: {% if brand.paper_texture_enabled %}1{% else %}0{% endif %};
      --paper-texture-strength: {{ brand.paper_texture_strength|default:100 }};
    }
  </style>
{% endwith %}

{# ... keep everything below exactly the same ... #}


    {# Consent + site scripts #}
    <script defer src="{% static 'js/consent.js' %}"></script>
    <script defer src="{% static 'js/theme.js' %}"></script>
    <script defer src="{% static 'js/site.js' %}"></script>

    {# Consent-gated analytics loader (robust: reads localStorage directly; does NOT depend on consent.js load order) #}
    {% with a=site_settings.site_settings.AnalyticsSettings %}
      {% if a.ga4_measurement_id or a.meta_pixel_id %}
        <script>
          (function () {
            var STORAGE_KEY = 'skinmenu_consent_v1';

            function readConsent() {
              try {
                var raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return { necessary: true, analytics: false, marketing: false };
                var parsed = JSON.parse(raw) || {};
                return {
                  necessary: true,
                  analytics: !!parsed.analytics,
                  marketing: !!parsed.marketing
                };
              } catch (e) {
                return { necessary: true, analytics: false, marketing: false };
              }
            }

            function loadGA4(measurementId) {
              if (!measurementId) return;
              if (window.__skinmenu_ga4_loaded) return;
              window.__skinmenu_ga4_loaded = true;

              var s = document.createElement('script');
              s.async = true;
              s.src = 'https://www.googletagmanager.com/gtag/js?id=' + encodeURIComponent(measurementId);
              document.head.appendChild(s);

              window.dataLayer = window.dataLayer || [];
              function gtag(){ window.dataLayer.push(arguments); }
              window.gtag = window.gtag || gtag;

              gtag('js', new Date());
              gtag('config', measurementId, { anonymize_ip: true });
            }

            function loadMetaPixel(pixelId) {
              if (!pixelId) return;
              if (window.__skinmenu_meta_loaded) return;
              window.__skinmenu_meta_loaded = true;

              !function(f,b,e,v,n,t,s){
                if(f.fbq) return;
                n=f.fbq=function(){ n.callMethod ? n.callMethod.apply(n,arguments) : n.queue.push(arguments) };
                if(!f._fbq) f._fbq=n;
                n.push=n; n.loaded=!0; n.version='2.0';
                n.queue=[];
                t=b.createElement(e); t.async=!0;
                t.src=v;
                s=b.getElementsByTagName(e)[0];
                s.parentNode.insertBefore(t,s);
              }(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

              window.fbq('init', pixelId);
              window.fbq('track', 'PageView');
            }

            function applyConsent() {
              var c = readConsent();
              if (c.analytics) loadGA4('{{ a.ga4_measurement_id|escapejs }}');
              if (c.marketing) loadMetaPixel('{{ a.meta_pixel_id|escapejs }}');
            }

            document.addEventListener('DOMContentLoaded', applyConsent);
            window.addEventListener('skinmenu:consent-updated', applyConsent);
          })();
        </script>
      {% endif %}
    {% endwith %}

    {# --- Site-wide structured data (Organization/LocalBusiness + BreadcrumbList + page-specific schemas) --- #}
    {% schema_json_ld %}

    {% block extra_head %}{% endblock %}
  </head>

  <body class="min-h-full bg-bg text-fg">
    {% wagtailuserbar %}

    <a
      href="#main"
      class="sr-only focus:not-sr-only focus:fixed focus:left-4 focus:top-4 focus:z-50 focus:rounded-md focus:bg-accent focus:px-4 focus:py-2 focus:text-fg"
    >
      Skip to content
    </a>

    {% include "partials/header.html" with settings=site_settings only %}

    <main id="main" class="min-h-[60vh]">
      {% block content %}{% endblock %}
    </main>

    {% include "partials/footer.html" with settings=site_settings %}

    {% include "partials/cookie_banner.html" %}

    <noscript>
      <div class="fixed bottom-0 left-0 right-0 bg-accent text-fg px-4 py-2 text-sm">
        This site works best with JavaScript enabled for navigation and interactive elements.
      </div>
    </noscript>
  </body>
</html>
