{% load wagtailimages_tags media_derivatives_tags  %}

<section class="relative">
  <div
    class="relative w-full overflow-hidden border-b border-border/30 bg-surface"
    data-carousel="hero"
    {% if block.value.hero_media and block.value.hero_media|length > 1 %}
      data-autoplay="true" data-interval="6500"
    {% elif not block.value.hero_media and block.value.hero_images and block.value.hero_images|length > 1 %}
      data-autoplay="true" data-interval="6500"
    {% endif %}
  >
    {# TRACK: keep it in its own stacking layer #}
    <div class="relative z-0 h-[62vh] min-h-[520px] w-full md:h-[76vh]" data-carousel-track>

      {# Preferred: hero_media (image and/or video) #}
      {% if block.value.hero_media %}
        {% for item in block.value.hero_media %}
          {% with media=item %}
            {% with px=media.pos_x|default:50 py=media.pos_y|default:50 %}
              <div
                class="absolute inset-0 transition-opacity duration-700 ease-out will-change-[opacity]
                       {% if forloop.first %}opacity-100{% else %}opacity-0{% endif %}"
                data-carousel-slide
                {% if forloop.first %}data-active="true"{% endif %}
              >
                {% if media.video %}
                  {# If an image is also provided, use it as poster + background fallback #}
                  {% if media.image %}
                    {% image media.image fill-2600x1600 as hero_img %}
                    <img
                      src="{{ hero_img.url }}"
                      width="{{ hero_img.width }}"
                      height="{{ hero_img.height }}"
                      alt="{{ media.image.title }}"
                      class="h-full w-full object-cover"
                      style="object-position: {{ px }}% {{ py }}%;"
                      {% if forloop.first %}fetchpriority="high"{% else %}loading="lazy"{% endif %}
                    />
                    {% hero_video_sources media.video.id as sources %}
                    <video
                      class="absolute inset-0 h-full w-full object-cover"
                      style="object-position: {{ px }}% {{ py }}%;"
                      {% if sources.poster %}poster="{{ sources.poster }}"{% else %}poster="{{ hero_img.url }}"{% endif %}
                      autoplay
                      muted
                      playsinline
                      preload="none"
                      {% if sources.mp4 %}data-video-src-mp4="{{ sources.mp4 }}"{% else %}data-video-src-mp4="{{ media.video.file.url }}"{% endif %}
                      {% if sources.webm %}data-video-src-webm="{{ sources.webm }}"{% endif %}
                      data-playback-rate="{{ media.playback_rate|default:'1.0' }}"
                    ></video> 
                  {% else %}
                  {% hero_video_sources media.video.id as sources %}
                  <video
                    class="h-full w-full object-cover"
                    style="object-position: {{ px }}% {{ py }}%;"
                    autoplay
                    muted
                    playsinline
                    preload="none"
                    {% if sources.poster %}poster="{{ sources.poster }}"{% endif %}
                    {% if sources.mp4 %}data-video-src-mp4="{{ sources.mp4 }}"{% else %}data-video-src-mp4="{{ media.video.file.url }}"{% endif %}
                    {% if sources.webm %}data-video-src-webm="{{ sources.webm }}"{% endif %}
                    data-playback-rate="{{ media.playback_rate|default:'1.0' }}"
                  ></video>
                  {% endif %}

                {% elif media.image %}
                  {% image media.image fill-2600x1600 as hero_img %}
                  <img
                    src="{{ hero_img.url }}"
                    width="{{ hero_img.width }}"
                    height="{{ hero_img.height }}"
                    alt="{{ media.image.title }}"
                    class="h-full w-full object-cover"
                    style="object-position: {{ px }}% {{ py }}%;"
                    {% if forloop.first %}fetchpriority="high"{% else %}loading="lazy"{% endif %}
                  />
                  

                {% else %}
                  <div class="absolute inset-0 flex items-center justify-center bg-surface-2 text-fg/70">
                    Add hero media in Wagtail → HomePage → Hero
                  </div>
                {% endif %}
                

                {# Scrim: keep subtle, but slightly stronger for video frames #}
                <div class="absolute inset-0 {% if media.video %}bg-bg/25 md:bg-bg/20{% else %}bg-bg/15{% endif %}"></div>
              </div>
            {% endwith %}
          {% endwith %}
        {% endfor %}

      {# Fallback: legacy hero_images list #}
      {% elif block.value.hero_images %}
        {% for img_obj in block.value.hero_images %}
          {% image img_obj fill-2600x1600 as hero_img %}
          <div
            class="absolute inset-0 transition-opacity duration-700 ease-out will-change-[opacity]
                   {% if forloop.first %}opacity-100{% else %}opacity-0{% endif %}"
            data-carousel-slide
            {% if forloop.first %}data-active="true"{% endif %}
          >
            <img
              src="{{ hero_img.url }}"
              width="{{ hero_img.width }}"
              height="{{ hero_img.height }}"
              alt="{{ img_obj.title }}"
              class="h-full w-full object-cover"
              {% if forloop.first %}fetchpriority="high"{% else %}loading="lazy"{% endif %}
            />
            <div class="absolute inset-0 bg-bg/15"></div>
          </div>
        {% endfor %}
      {% else %}
        <div class="absolute inset-0 flex items-center justify-center bg-surface-2 text-fg/70">
          Add hero images in Wagtail → HomePage → Hero
        </div>
      {% endif %}
    </div>

    {# OVERLAY (ensure it's above slides but below dots) #}
    <div class="pointer-events-none absolute inset-0 z-20">
      <div class="container-shell h-full">
        {% if block.value.cta_position == "bottom_left" %}
          <div class="flex h-full items-end justify-start pb-10 md:pb-14">
            <div class="pointer-events-auto max-w-2xl">
        {% elif block.value.cta_position == "bottom_right" %}
          <div class="flex h-full items-end justify-end pb-10 md:pb-14">
            <div class="pointer-events-auto max-w-2xl text-right">
        {% elif block.value.cta_position == "top_left" %}
          <div class="flex h-full items-start justify-start pt-10 md:pt-14">
            <div class="pointer-events-auto max-w-2xl">
        {% elif block.value.cta_position == "top_right" %}
          <div class="flex h-full items-start justify-end pt-10 md:pt-14">
            <div class="pointer-events-auto max-w-2xl text-right">
        {% else %}
          <div class="flex h-full items-center justify-center py-10">
            <div class="pointer-events-auto max-w-2xl text-center">
        {% endif %}

              {# Pop text only when the first hero_media item is a video #}
              <h1 class="text-4xl leading-[1.02] md:text-6xl {% if block.value.hero_media and block.value.hero_media.0.video %}text-white/95 hero-title-pop{% endif %}">
                {{ block.value.headline }}
              </h1>

              {% if block.value.subheadline %}
                <p class="mt-4 max-w-prose md:text-lg {% if block.value.hero_media and block.value.hero_media.0.video %}text-white/85 hero-subtitle-pop{% else %}text-fg/85{% endif %}">
                  {{ block.value.subheadline }}
                </p>
              {% endif %}

              {# CHANGE: CTA only renders if explicitly enabled AND has data #}
              {% if block.value.show_primary_cta and block.value.primary_cta %}
                <div class="mt-6">
                  <a class="btn-primary btn-lg" href="{{ block.value.primary_cta.url }}">
                    {{ block.value.primary_cta.label }}
                  </a>
                </div>
              {% endif %}
            </div>
          </div>
      </div>
    </div>

    {# DOTS: absolutely above everything (including video) #}
    {% if block.value.hero_media and block.value.hero_media|length > 1 %}
      <div class="absolute bottom-6 left-0 right-0 z-35 pointer-events-auto">
        <div class="container-shell">
          <div class="flex items-center gap-2" data-carousel-dots aria-label="Hero slides">
            {% for _ in block.value.hero_media %}
              <button
                type="button"
                class="carousel-dot"
                aria-label="Go to slide {{ forloop.counter }}"
                data-carousel-dot="{{ forloop.counter0 }}"
                {% if forloop.first %}aria-current="true"{% endif %}
              ></button>
            {% endfor %}
          </div>
        </div>
      </div>
    {% elif not block.value.hero_media and block.value.hero_images and block.value.hero_images|length > 1 %}
      <div class="absolute bottom-6 left-0 right-0 z-50 pointer-events-auto">
        <div class="container-shell">
          <div class="flex items-center gap-2" data-carousel-dots aria-label="Hero slides">
            {% for _ in block.value.hero_images %}
              <button
                type="button"
                class="carousel-dot"
                aria-label="Go to slide {{ forloop.counter }}"
                data-carousel-dot="{{ forloop.counter0 }}"
                {% if forloop.first %}aria-current="true"{% endif %}
              ></button>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</section>
