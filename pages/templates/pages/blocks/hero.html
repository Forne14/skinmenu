{% load wagtailimages_tags %}

<section class="relative">
  <div
    class="relative w-full overflow-hidden border-b border-border/30 bg-surface"
    data-carousel="hero"
    {% if block.value.hero_media and block.value.hero_media|length > 1 %}
      data-autoplay="true" data-interval="6500"
    {% elif not block.value.hero_media and block.value.hero_images and block.value.hero_images|length > 1 %}
      data-autoplay="true" data-interval="6500"
    {% endif %}
  >
    {# Slides layer (lowest) #}
    <div class="relative z-0 h-[62vh] min-h-[520px] w-full md:h-[76vh]" data-carousel-track>

      {# Preferred: hero_media (image and/or video) #}
      {% if block.value.hero_media %}
        {% for item in block.value.hero_media %}
          {% with media=item %}
            {% firstof media.pos_x 50 as fx %}
            {% firstof media.pos_y 50 as fy %}

            <div
              class="absolute inset-0 z-0 transition-opacity duration-700 ease-out will-change-[opacity]
                     {% if forloop.first %}opacity-100{% else %}opacity-0{% endif %}"
              data-carousel-slide
              {% if forloop.first %}data-active="true"{% endif %}
            >
              {% if media.video %}
                {# A) image+video in the same item = poster + video (one slide) #}
                {% if media.image %}
                  {% image media.image fill-2600x1600 as hero_img %}
                  {# Keep a real image underneath as a fast first-paint fallback #}
                  <img
                    src="{{ hero_img.url }}"
                    width="{{ hero_img.width }}"
                    height="{{ hero_img.height }}"
                    alt="{{ media.image.title }}"
                    class="absolute inset-0 h-full w-full object-cover"
                    style="object-position: {{ fx }}% {{ fy }}%;"
                    {% if forloop.first %}fetchpriority="high"{% else %}loading="lazy"{% endif %}
                  />
                  <video
                    class="absolute inset-0 h-full w-full object-cover"
                    style="object-position: {{ fx }}% {{ fy }}%;"
                    src="{{ media.video.file.url }}"
                    poster="{{ hero_img.url }}"
                    autoplay
                    muted
                    playsinline
                    preload="{% if forloop.first %}auto{% else %}metadata{% endif %}"
                    {% if media.loop %}loop{% endif %}
                    data-playback-rate="{{ media.playback_rate|default:'1.0' }}"
                  ></video>
                {% else %}
                  <video
                    class="absolute inset-0 h-full w-full object-cover"
                    style="object-position: {{ fx }}% {{ fy }}%;"
                    src="{{ media.video.file.url }}"
                    autoplay
                    muted
                    playsinline
                    preload="{% if forloop.first %}auto{% else %}metadata{% endif %}"
                    {% if media.loop %}loop{% endif %}
                    data-playback-rate="{{ media.playback_rate|default:'1.0' }}"
                  ></video>
                {% endif %}

              {% elif media.image %}
                {% image media.image fill-2600x1600 as hero_img %}
                <img
                  src="{{ hero_img.url }}"
                  width="{{ hero_img.width }}"
                  height="{{ hero_img.height }}"
                  alt="{{ media.image.title }}"
                  class="absolute inset-0 h-full w-full object-cover"
                  style="object-position: {{ fx }}% {{ fy }}%;"
                  {% if forloop.first %}fetchpriority="high"{% else %}loading="lazy"{% endif %}
                />
              {% else %}
                <div class="absolute inset-0 flex items-center justify-center bg-surface-2 text-fg/70">
                  Add hero media in Wagtail → HomePage → Hero
                </div>
              {% endif %}

              {# Scrim above media, below text/dots #}
              <div class="absolute inset-0 z-10 bg-bg/15"></div>
            </div>
          {% endwith %}
        {% endfor %}

      {# Fallback: legacy hero_images list #}
      {% elif block.value.hero_images %}
        {% for img_obj in block.value.hero_images %}
          {% image img_obj fill-2600x1600 as hero_img %}
          <div
            class="absolute inset-0 z-0 transition-opacity duration-700 ease-out will-change-[opacity]
                   {% if forloop.first %}opacity-100{% else %}opacity-0{% endif %}"
            data-carousel-slide
            {% if forloop.first %}data-active="true"{% endif %}
          >
            <img
              src="{{ hero_img.url }}"
              width="{{ hero_img.width }}"
              height="{{ hero_img.height }}"
              alt="{{ img_obj.title }}"
              class="absolute inset-0 h-full w-full object-cover"
              {% if forloop.first %}fetchpriority="high"{% else %}loading="lazy"{% endif %}
            />
            <div class="absolute inset-0 z-10 bg-bg/15"></div>
          </div>
        {% endfor %}
      {% else %}
        <div class="absolute inset-0 flex items-center justify-center bg-surface-2 text-fg/70">
          Add hero images in Wagtail → HomePage → Hero
        </div>
      {% endif %}
    </div>

    {# Overlay content (middle) #}
    <div class="pointer-events-none absolute inset-0 z-20">
      <div class="container-shell h-full">
        {% if block.value.cta_position == "bottom_left" %}
          <div class="flex h-full items-end justify-start pb-10 md:pb-14">
            <div class="pointer-events-auto max-w-2xl">
        {% elif block.value.cta_position == "bottom_right" %}
          <div class="flex h-full items-end justify-end pb-10 md:pb-14">
            <div class="pointer-events-auto max-w-2xl text-right">
        {% elif block.value.cta_position == "top_left" %}
          <div class="flex h-full items-start justify-start pt-10 md:pt-14">
            <div class="pointer-events-auto max-w-2xl">
        {% elif block.value.cta_position == "top_right" %}
          <div class="flex h-full items-start justify-end pt-10 md:pt-14">
            <div class="pointer-events-auto max-w-2xl text-right">
        {% else %}
          <div class="flex h-full items-center justify-center py-10">
            <div class="pointer-events-auto max-w-2xl text-center">
        {% endif %}

              <h1 class="text-4xl leading-[1.02] md:text-6xl">
                {{ block.value.headline }}
              </h1>

              {% if block.value.subheadline %}
                <p class="mt-4 max-w-prose text-base text-fg/85 md:text-lg">
                  {{ block.value.subheadline }}
                </p>
              {% endif %}

              {% if block.value.primary_cta %}
                <div class="mt-6">
                  <a class="btn-primary btn-lg" href="{{ block.value.primary_cta.url }}">
                    {{ block.value.primary_cta.label }}
                  </a>
                </div>
              {% endif %}
            </div>
          </div>
      </div>
    </div>

    {# Dots (top) – always above videos/images #}
    {% if block.value.hero_media and block.value.hero_media|length > 1 %}
      <div class="absolute bottom-6 left-0 right-0 z-40 pointer-events-auto">
        <div class="container-shell">
          <div class="flex items-center gap-2" data-carousel-dots aria-label="Hero slides">
            {% for _ in block.value.hero_media %}
              <button
                type="button"
                class="carousel-dot"
                aria-label="Go to slide {{ forloop.counter }}"
                data-carousel-dot="{{ forloop.counter0 }}"
                {% if forloop.first %}aria-current="true"{% endif %}
              ></button>
            {% endfor %}
          </div>
        </div>
      </div>
    {% elif not block.value.hero_media and block.value.hero_images and block.value.hero_images|length > 1 %}
      <div class="absolute bottom-6 left-0 right-0 z-40 pointer-events-auto">
        <div class="container-shell">
          <div class="flex items-center gap-2" data-carousel-dots aria-label="Hero slides">
            {% for _ in block.value.hero_images %}
              <button
                type="button"
                class="carousel-dot"
                aria-label="Go to slide {{ forloop.counter }}"
                data-carousel-dot="{{ forloop.counter0 }}"
                {% if forloop.first %}aria-current="true"{% endif %}
              ></button>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</section>
